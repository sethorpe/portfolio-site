name: Playwright Tests

on:
  push:
    branches:
      - main  # Runs on pushes to main
  pull_request:
    branches:
      - main  # Runs on PRs to main

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Prevent long-hanging jobs

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: npm  # Caches npm dependencies to speed up CI runs

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Wait for deployment to be ready
        run: |
          BASE_URL="https://portfolio-site-git-add-ui-tests-seyi-thorpes-projects.vercel.app"
          echo "Waiting for deployment at $BASE_URL..."

          MAX_ATTEMPTS=36  # 3 minutes max (36 x 5s)
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $BASE_URL)

            if [ "$HTTP_STATUS" = "200" ]; then
              echo "SUCCESS: Deployment is ready (HTTP $HTTP_STATUS)"
              break
            else
              echo "  Waiting... (HTTP $HTTP_STATUS, attempt $((ATTEMPT + 1))/$MAX_ATTEMPTS)"
            fi

            sleep 5
            ATTEMPT=$((ATTEMPT + 1))
          done

          if [ $ATTEMPT -ge $MAX_ATTEMPTS ]; then
            echo "ERROR: Deployment not ready after 3 minutes"
            exit 1
          fi

          echo "BASE_URL=$BASE_URL" >> $GITHUB_ENV

      - name: Run Playwright tests
        run: npx playwright test
