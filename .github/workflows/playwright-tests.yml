name: Playwright Tests

on:
  push:
    branches:
      - main  # Runs on pushes to main
  pull_request:
    branches:
      - main  # Runs on PRs to main

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Prevent long-hanging jobs

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: npm  # Caches npm dependencies to speed up CI runs

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Wait for Vercel deployment to complete
        run: |
          echo "Finding latest deployment..."

          # Get the most recent deployment ID for this branch
          DEPLOYMENT_ID=$(curl -s \
            "https://api.vercel.com/v6/deployments?projectId=${{ secrets.VERCEL_PROJECT_ID }}&teamId=${{ secrets.VERCEL_ORG_ID }}&target=preview" \
            -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
            | jq -r '.deployments[0].uid')

          if [ "$DEPLOYMENT_ID" = "null" ] || [ -z "$DEPLOYMENT_ID" ]; then
            echo "ERROR: No deployment found!"
            exit 1
          fi

          echo "Found deployment: $DEPLOYMENT_ID"
          echo "Waiting for deployment to complete..."

          # Wait for deployment to be ready
          MAX_ATTEMPTS=30  # 5 minutes max (30 x 10s)
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            STATUS=$(curl -s \
              "https://api.vercel.com/v13/deployments/$DEPLOYMENT_ID" \
              -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
              | jq -r '.readyState')

            echo "  Status: $STATUS (attempt $((ATTEMPT + 1))/$MAX_ATTEMPTS)"

            if [ "$STATUS" = "READY" ]; then
              echo "SUCCESS: Deployment is ready!"
              break
            elif [ "$STATUS" = "ERROR" ]; then
              echo "ERROR: Deployment failed!"
              exit 1
            fi

            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done

          if [ $ATTEMPT -ge $MAX_ATTEMPTS ]; then
            echo "ERROR: Timeout - Deployment took too long"
            exit 1
          fi

          # Get the deployment URL
          DEPLOYMENT_URL=$(curl -s \
            "https://api.vercel.com/v13/deployments/$DEPLOYMENT_ID" \
            -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
            | jq -r '.url')

          echo "Deployment URL: https://$DEPLOYMENT_URL"
          echo "BASE_URL=https://$DEPLOYMENT_URL" >> $GITHUB_ENV

      - name: Run Playwright tests
        run: npx playwright test
