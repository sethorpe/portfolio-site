name: Playwright Tests

on:
  push:
    branches:
      - main  # Runs on pushes to main
  pull_request:
    branches:
      - main  # Runs on PRs to main

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Prevent long-hanging jobs

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: npm  # Caches npm dependencies to speed up CI runs

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Wait for Vercel deployment to complete
        run: |
          echo "Waiting for deployment matching commit SHA: ${{ github.sha }}"

          MAX_WAIT_ATTEMPTS=36  # 6 minutes max to find deployment (36 x 10s)
          WAIT_ATTEMPT=0
          DEPLOYMENT_ID=""

          # Poll until we find a deployment for this commit
          while [ $WAIT_ATTEMPT -lt $MAX_WAIT_ATTEMPTS ]; do
            echo "  Looking for deployment... (attempt $((WAIT_ATTEMPT + 1))/$MAX_WAIT_ATTEMPTS)"

            DEPLOYMENT_ID=$(curl -s \
              "https://api.vercel.com/v6/deployments?projectId=${{ secrets.VERCEL_PROJECT_ID }}&teamId=${{ secrets.VERCEL_ORG_ID }}" \
              -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
              | jq -r --arg sha "${{ github.sha }}" '.deployments[] | select(.meta.githubCommitSha == $sha) | .uid' \
              | head -n 1)

            if [ -n "$DEPLOYMENT_ID" ] && [ "$DEPLOYMENT_ID" != "null" ]; then
              echo "Found deployment for commit: $DEPLOYMENT_ID"
              break
            fi

            sleep 10
            WAIT_ATTEMPT=$((WAIT_ATTEMPT + 1))
          done

          if [ -z "$DEPLOYMENT_ID" ] || [ "$DEPLOYMENT_ID" = "null" ]; then
            echo "ERROR: No deployment found for commit ${{ github.sha }} after $((MAX_WAIT_ATTEMPTS * 10)) seconds"
            exit 1
          fi

          echo "Waiting for deployment to be ready..."

          # Wait for deployment to be ready
          MAX_READY_ATTEMPTS=30  # 5 minutes max (30 x 10s)
          READY_ATTEMPT=0

          while [ $READY_ATTEMPT -lt $MAX_READY_ATTEMPTS ]; do
            STATUS=$(curl -s \
              "https://api.vercel.com/v13/deployments/$DEPLOYMENT_ID" \
              -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
              | jq -r '.readyState')

            echo "  Status: $STATUS (attempt $((READY_ATTEMPT + 1))/$MAX_READY_ATTEMPTS)"

            if [ "$STATUS" = "READY" ]; then
              echo "SUCCESS: Deployment is ready!"
              break
            elif [ "$STATUS" = "ERROR" ]; then
              echo "ERROR: Deployment failed!"
              exit 1
            fi

            sleep 10
            READY_ATTEMPT=$((READY_ATTEMPT + 1))
          done

          if [ $READY_ATTEMPT -ge $MAX_READY_ATTEMPTS ]; then
            echo "ERROR: Timeout - Deployment took too long to become ready"
            exit 1
          fi

          # Get the deployment URL
          DEPLOYMENT_URL=$(curl -s \
            "https://api.vercel.com/v13/deployments/$DEPLOYMENT_ID" \
            -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
            | jq -r '.url')

          echo "Deployment URL: https://$DEPLOYMENT_URL"
          echo "BASE_URL=https://$DEPLOYMENT_URL" >> $GITHUB_ENV

      - name: Verify deployment is accessible
        run: |
          echo "Verifying deployment is accessible..."
          MAX_ATTEMPTS=12
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $BASE_URL)

            if [ "$HTTP_STATUS" = "200" ]; then
              echo "SUCCESS: Site is responding (HTTP $HTTP_STATUS)"
              break
            else
              echo "  Waiting for site to respond... (HTTP $HTTP_STATUS, attempt $((ATTEMPT + 1))/$MAX_ATTEMPTS)"
            fi

            sleep 5
            ATTEMPT=$((ATTEMPT + 1))
          done

          if [ $ATTEMPT -ge $MAX_ATTEMPTS ]; then
            echo "ERROR: Site is not responding after deployment"
            exit 1
          fi

      - name: Run Playwright tests
        run: npx playwright test
